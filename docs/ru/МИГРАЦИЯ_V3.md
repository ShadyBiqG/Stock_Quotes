# Миграция Stock Quotes на версию 3.0

## Обзор изменений

Версия 3.0 представляет собой крупное обновление архитектуры проекта:

### Основные изменения

1. **Удален файл `data/samples/Stock quotes.xlsx`**
   - Список компаний теперь хранится в `config/companies.json`
   - Котировки получаются автоматически через Yahoo Finance API
   - Все данные хранятся в базе данных

2. **Разделение конфигурации**
   - `config/api_keys.yaml` - API ключи (в .gitignore)
   - `config/llm_config.yaml` - настройки LLM моделей (в .gitignore)
   - `config/companies.json` - список компаний (в .gitignore)

3. **Автоматическое получение котировок**
   - Новый модуль `src/price_fetcher.py`
   - Интеграция с Yahoo Finance API
   - Fallback на значения по умолчанию

4. **Улучшенное управление компаниями**
   - Добавление компаний через веб-интерфейс
   - Автоматическое сохранение в `companies.json`
   - Экспорт списка компаний для резервного копирования

## Преимущества v3.0

✅ **Безопасность**: API ключи отделены от кода и не попадают в Git  
✅ **Гибкость**: Легко управлять списком компаний без Excel  
✅ **Автоматизация**: Котировки обновляются автоматически  
✅ **Резервное копирование**: Список компаний всегда актуален  
✅ **Масштабируемость**: Легко добавлять новые источники данных

## Автоматическая миграция

### Шаг 1: Запуск скрипта миграции

```bash
python scripts/migrate_to_v3.py
```

Скрипт выполнит:
1. Экспорт компаний из БД в `config/companies.json`
2. Создание `config/api_keys.yaml` и `config/llm_config.yaml`
3. Опционально: очистку БД (котировки и анализы)
4. Резервное копирование старых файлов
5. Удаление `data/samples/Stock quotes.xlsx`

### Шаг 2: Проверка конфигурации

После миграции проверьте файлы:

```
config/
├── api_keys.yaml          # Проверьте API ключи
├── llm_config.yaml        # Проверьте настройки моделей
└── companies.json         # Проверьте список компаний
```

### Шаг 3: Тестирование

Запустите приложение:

```bash
# CLI
python main.py

# Веб-интерфейс
streamlit run app.py
```

## Ручная миграция

Если автоматическая миграция не сработала, выполните вручную:

### 1. Создание структуры

```bash
mkdir config
```

### 2. Создание api_keys.yaml

Скопируйте из `config.yaml`:

```yaml
# config/api_keys.yaml
openrouter_api_key: "sk-or-v1-ваш-ключ"
alphavantage_api_key: ""
```

### 3. Создание llm_config.yaml

Скопируйте остальные настройки из `config.yaml`:

```yaml
# config/llm_config.yaml
openrouter:
  base_url: "https://openrouter.ai/api/v1"

models:
  - name: "GPT-4 Turbo"
    id: "openai/gpt-4-turbo"
    temperature: 0.3
    max_tokens: 1000
  # ... остальные модели

# ... остальные секции
```

### 4. Создание companies.json

Экспортируйте компании из БД или создайте вручную:

```json
{
  "companies": [
    {
      "ticker": "AAPL",
      "name": "Apple Inc.",
      "sector": "Technology",
      "industry": "Consumer Electronics"
    }
  ],
  "last_updated": "2026-02-04T12:00:00"
}
```

### 5. Обновление .gitignore

Убедитесь, что добавлены:

```
config/api_keys.yaml
config/llm_config.yaml
config/companies.json
```

## Breaking Changes

### 1. Загрузка данных

**Было (v2.x):**
```python
from src.data_loader import load_stock_data

stocks = load_stock_data("data/samples/Stock quotes.xlsx", database=db)
```

**Стало (v3.0):**
```python
from src.data_loader import load_stock_data
from src.price_fetcher import YahooFinanceFetcher

price_fetcher = YahooFinanceFetcher()
stocks = load_stock_data("config/companies.json", database=db, price_fetcher=price_fetcher)
```

### 2. Конфигурация

**Было (v2.x):**
```python
import yaml

with open("config.yaml", 'r') as f:
    config = yaml.safe_load(f)
```

**Стало (v3.0):**
```python
# Используйте функцию load_config() из main.py или app.py
# Она автоматически обрабатывает новую структуру
```

### 3. Добавление компаний

**Было (v2.x):**
- Редактирование Excel файла вручную
- Добавление строк с Ticker, Price, Change, Volume

**Стало (v3.0):**
- Через веб-интерфейс: Настройки → Управление компаниями → Добавить
- Автоматическое получение цены через Yahoo Finance
- Автоматическое сохранение в `companies.json`

## Откат на v2.x

Если возникли проблемы, можно вернуться к старой версии:

1. Восстановите резервную копию `config.yaml`:
   ```bash
   copy config_backup_YYYYMMDD_HHMMSS.yaml config.yaml
   ```

2. Восстановите Excel файл:
   ```bash
   copy "data\samples\Stock quotes_backup_YYYYMMDD_HHMMSS.xlsx" "data\samples\Stock quotes.xlsx"
   ```

3. Удалите папку `config/` (опционально)

4. Откатите код на предыдущий коммит:
   ```bash
   git checkout HEAD~1
   ```

## FAQ

### В: Что делать, если миграция прервалась с ошибкой?

О: Проверьте:
1. Наличие `config.yaml` в корне проекта
2. Наличие базы данных `data/stock_analysis.db`
3. Права на запись в папку `config/`

Запустите миграцию повторно - она безопасна для повторного запуска.

### В: Можно ли использовать старый config.yaml?

О: Да, v3.0 поддерживает fallback на старый формат. Но рекомендуется миграция для:
- Лучшей безопасности (API ключи в .gitignore)
- Автоматического получения котировок
- Удобного управления компаниями

### В: Где хранятся котировки в v3.0?

О: Все котировки хранятся в базе данных `data/stock_analysis.db`. При добавлении новой компании:
1. Получается информация через LLM
2. Получается текущая цена через Yahoo Finance
3. Данные сохраняются в БД
4. Тикер добавляется в `companies.json` для резервного копирования

### В: Как добавить компанию в v3.0?

О: Два способа:

**Через веб-интерфейс (рекомендуется):**
1. Откройте `streamlit run app.py`
2. Перейдите в "Настройки"
3. Раздел "Управление компаниями" → "Добавить новую компанию"
4. Введите тикер (например, TSLA)
5. Нажмите "Добавить"

**Вручную:**
1. Отредактируйте `config/companies.json`
2. Добавьте тикер в массив `companies`
3. При следующем запуске котировки будут получены автоматически

### В: Нужно ли удалять старый config.yaml?

О: Не обязательно. Скрипт миграции создает резервную копию. Вы можете удалить `config.yaml` после успешного тестирования v3.0.

### В: Что делать, если Yahoo Finance не возвращает данные?

О: Система автоматически использует fallback:
1. Попытка получить через Yahoo Finance
2. При ошибке - использование значений по умолчанию (price=100.0, change=0%)
3. Источник данных сохраняется в таблице `price_sources`

Проверьте логи для деталей: `logs/analysis.log`

### В: Как экспортировать список компаний?

О: В веб-интерфейсе:
1. Настройки → Управление компаниями
2. Кнопка "Экспорт в JSON"
3. Все компании из БД будут сохранены в `config/companies.json`

Используйте это для резервного копирования или переноса на другой сервер.

## Поддержка

При возникновении проблем:
1. Проверьте логи: `logs/analysis.log`
2. Убедитесь, что все файлы конфигурации созданы
3. Проверьте права доступа к папкам `config/` и `data/`
4. Создайте issue на GitHub с описанием проблемы

## Контрольный список миграции

- [ ] Создана резервная копия `config.yaml`
- [ ] Создана резервная копия БД `data/stock_analysis.db`
- [ ] Запущен `python scripts/migrate_to_v3.py`
- [ ] Проверены файлы в `config/`
- [ ] API ключи корректны в `config/api_keys.yaml`
- [ ] Список компаний в `config/companies.json`
- [ ] Протестирован запуск: `python main.py`
- [ ] Протестирован веб-интерфейс: `streamlit run app.py`
- [ ] Добавлена тестовая компания через веб-интерфейс
- [ ] Проверена автоматическая синхронизация с `companies.json`
- [ ] Удалены резервные копии (после успешного тестирования)
